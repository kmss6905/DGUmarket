### 회원가입 2단계, 3단계 페이지 이동



**회원가입 2단계 페이지 이동**

우리 서비스에서 페이지 접근과 관련한 기준은 `인증여부`가 있었습니다. 예를 들어 인증이 필요한 페이지에는 토큰을 통해 유효성 검증을 통과해야 접근할 수 있었습니다. (예 - 상품 업로드 페이지, 회원 프로필 정보 조회 페이지 등)

회원가입 2단계 페이지는 인증이 필요 없습니다. 따라서 비회원 유저가 접근할 수 있습니다. 하지만 회원가입 절차 상 웹메일 인증을 마친 비회원 유저가 접근할 수 있으므로, 2단계 또는 3단계 페이지 이동 시 토큰을 검사해 유효성을 검사합니다. 검사 내용은 다음과 같습니다.

- 유효한 링크를 통해 회원가입 2단계 페이지로 이동했는가?
- 이미 회원인 유저가 접근하지 않았는가? 

두 검증을 모두 통과한 경우 2단계 페이지로 이동할 수 있습니다. 검증 과정에서 통과하지 못한 경우에는 **메인** 페이지로 리다이렉트 처리합니다. 메인 페이지로 리다이렉트 처리될 때 클라이언트 측에서 "잘못된 접근입니다." 라는 Alert를 띄우면 좋을 것 같습니다. 정확하지는 않지만 클라이언트 로직에 대해서도 언급하자면, Alert를 띄우는 순서는 다음과 같습니다.

1. 링크 클릭 
2. (서버) 유효성 검사 ... 통과 실패 .. 메인 페이지로 리다이렉트 
3. (클라이언트) 200 / redirect === true 
   1.  이 시점에는 이미 메인 페이지를 반환 받았을 시점입니다. 반환 받은 것을 화면에 렌더링 하기 전에 Alert를 띄우면 어떨까 생각했습니다. 

(참고) **회원가입 2단계 페이지에서 웹메일 정보는 어떻게 알 수 있죠?**

회원가입 2단계 페이지에는 웹메일에 전송된 링크를 통해 접근할 수 있습니다. 링크를 통해 2단계 페이지를 반환 받을 때 응답 헤더 `webMail` 키 값에 링크와 대응되는 웹메일 정보가 있습니다. 응답 헤더를 직접 눈으로 확인하시고 해당 값을 활용하시면 됩니다.

___

**회원가입 3단계 페이지 이동**

회원가입 3단계 페이지는 2단계 페이지에서 핸드폰 인증이 완료된 시점에 이동하게 됩니다. 서버로부터 3단계 페이지에 접근할 수 있는 Location(URL)을 응답 받고 해당 값을 활용해서 3단계 페이에 접근하게 됩니다. (Location.href 활용)

앞서 언급한 것처럼 핸드폰 인증이 완료된 시점에 3단계 페이지 주소 값을 반환 받으므로, 핸드폰 인증 API 문서를 확인하시면 자세한 스펙을 알 수 있습니다. 

3단계 페이지 역시 2단계 페이지 이동과 동일하게 토큰 값을 `쿼리 파람` 으로 받아서 서버 측에서 유효성 검사를 통과한 후에 페이지를 반환 받는 과정을 거치게 됩니다. 실제로 핸드폰 인증 API 응답 값 예시는 다음과 같습니다. 

```json
실제 서버에 적용하게 되면 HTTPS 프로토콜로 변경할 예정입니다. (참고)

http://localhost:8081/shop/account/smartPhone_certification?user_id=토큰값 

```

___

# [여기를 읽어주세요]

[회원가입 서버 2차 테스트 관련 수정] : **Alert** 

"잘못된 접근입니다." Alert를 띄우기 위해서, 서버는 예외가 발생했을 때(토큰이 유효하지 않거나, 없는 경우) 리다이렉트로 페이지 이동을 시키는 것이 아닌 클라이언트가 이동할 페이지 경로 값을 넘겨주게 됩니다. (<u>진영 생각</u> 그대로 인용)

페이지 요청 시 토큰이 유효하지 않은 경우 또는 토큰 없이 페이지 접근 시 아래와 같이 응답을 합니다. 

```json
Spring Framework에서 기본적으로 제공하는 예외 응답 Body를 활용해서 아래 불필요한 요소도 포함되어 있습니다. ex) requestId 등 
이 부분은 추후 커스텀해서 변경할 경우 따로 공지하겠습니다. 

기존 방식은 서버에서 리다이렉트를 통해 페이지를 반환하면서 Alert 시점을 두기 어려웠습니다. 따라서 진영씨가 말씀하신대로 'pathToMove' 키 값에 대응되는 메인페이지 경로 값을 활용해서 메인 페이지로 이동시키시면 되고, 필요한 시점에 Alert 띄워서 "잘못된 접근입니다." 유저에게 안내해주면 됩니다. 

기본적으로 아래 두 케이스 모두 200번 응답을 받고, 내부 요소 중 'status' 값을 식별해서 302인 경우 페이지 이동으로 하시면 됩니다. 
(참고 - 아래 두 케이스 모두 status는 302 입니다. 동일한 처리를 하기 때문에 따로 구분하지 않았습니다.)



[HTTP/1.1 200 OK]
{
    "timestamp": "2021-03-22T04:30:02.602+00:00",
    "path": "/shop/account/smartPhone_certification",
    "status": 302,
    "error": "Internal Server Error",
    "message": "토큰이 유효하지 않은 경우 (DB 토큰과 값이 다른 경우)",
    "requestId": "d847c5da-1",
    "exception": "com.springcloud.gateway.exception.Register2ndException",
    "pathToMove": "/shop/main/index"
}

[HTTP/1.1 200 OK]
{
    "timestamp": "2021-03-22T04:30:13.867+00:00",
    "path": "/shop/account/smartPhone_certification",
    "status": 302,
    "error": "Internal Server Error",
    "message": "회원가입 2 또는 3 페이지 쿼리파람 없이 접근",
    "requestId": "d847c5da-2",
    "exception": "com.springcloud.gateway.exception.Register2ndException",
    "pathToMove": "/shop/main/index"
}
```







____





