# 채팅방 상태 조회하기

여기서 말하는 상태란, 유저가 채팅방에 들어갔을 떄 구매자입장에서 들어갔는지, 판매자 입장에서 들어갔는지
구매자 입장에서 들어갔다면 판매자가 거래완료를 눌렀는 지 누르지 않았는지
판매자가 구매완료 버튼을 눌렀다면 구매자 채팅방은 어떻게 확인할 수 있는 지를 조회하는 API 이다.

**결론 : 유저가 채팅방 목록에서 채팅방으로 들어갈 떄 아래의 엔드포인트로 요청한다**


---

**추가된내용**

## 1.
기존에는 사용자가 탈퇴하거나 관리자로부터 제재당했을 경우는 존재하지 않았다. 하지만 채팅 상대방이 탈퇴하거나 관리자로부터 제재당하는 경우 채팅방에 들어갔을 때 어떠한 인터렉션을 하지 못하도록 막아야하기 때문에 채팅방 들어갈 때 상대방이 탈퇴나 유저제재를 당했는 지 체크하게 됩니다.


채팅방에 들어갔는 데 상대방이 관리자로 부터 제재를 받고 있거나 탈퇴한 유저라면 차단한 유저의 채팅방에 들어간 것과 마찬가지로 적절한 UI를 그리면 될것이다.

이때는 당연 거래완료했는 지, 구매후기를 남겼는 지, 구매후기를 남겼다면 볼 수 있는 형태가 있는 지 등등은 모두 없어지고 하나의 섹션의 문구를 띄워주면 된다.

**제재** -> "해당 사용자는 관리자로 부터 이용제재 받는 중입니다. 자세한 내용은 아래의 메일로 문의바랍니다. "

**탈퇴** -> "해당 사용자는 현재 탈퇴한 상태입니다"


## 2.

응답값에는 `isWarn` (boolean) 이 추가됩니다.
이 값은 채팅방 상대방 유저가 경고를 받고 있는 지 받고 있지 않는 지에 대한 유무를 표현합니다.

가령 `isWarn` : true 는 채팅방에 들어갔을 때 상대방 유저가 `경고` 를 받고 있다는 상태이다 그렇기 때문에 클라이언트는 채팅방 어느곳에 적절하게 채팅방 상대방이 경고를 받고 있다는 사실을 UI로 알려줘야 한다.!!

`isWarn` : false(defalut) , 이 경우는 경고를 받고 있지 않는 상태를 뜻하기 때문에 따로 경고표시를 하지 않아도 된다.


*잠깐*
경고에 대해서 설명하자면, 경고란 운영자가 유저에게 주는 옐로우카드와 같은 효과를 지닌다.
isWarn 이 true 가 되기 위해서는 경고를 3번 받아야 한다. (5번이 되면 자동으로 이용자제재로 넘어간다.)
즉 1번 2번 경고를 관리자로 부터 받는 것은 아무런 의미가 없다. 
다만, 1번,2번 경고를 줄 때는 운영자는 사용자에게 경고를 줬다는 메시지를 주게되고 경각심을 불러일으킬수있도록 한다.
경고 한번에 내거래정보와 내가올린물건페이지에 경고딱지가 붙게되면 너무 패널티가 크다는 생각에 위와 같은 정책을 도입했다.


## 3.

응답값에서는 `block_status` 값이 추가됩니다. 이는 기존에 채팅방에 들어갈 때
차단유무 조회 API를 사용하지 않고, 채팅방 상태조회 API를 요청할 때 해당유저에 대해서 차단유무까지
조회한 결과를 한꺼번에 알려주겠다는 의미입니다.

따라서 기존에는 채팅방 들어 갈때 요청하던 API가 세 가지(1.차단조회API, 2.채팅방상태조회 API, 3. 채팅방 상단 물건정보조회 API) 였는 데


이제는 API 두개만 요청한다(1. 채팅방상태조회, 2. 채팅방 상단 물건정보 조회)
차단조회 API를 요청하는 것이 아닌 채팅방 상태조회 API만 요청하면 차단유무까지 알 수 있도록 하여 채팅방 상태조회 API만 요청해도 차단유무를 알 수 있도록 한다는 뜻


---


**URL** : `/api/chatroom/{roomId}/status`

**Method** : `GET`

**request param(path)** :

`{roomId}` : 들어가려는 채팅방 번호

**Authentication required** : `yes`

## Success Responses

**Content**

`message`: 응답 메시지

`status`: 응답 상태

`data`: 채팅방 상태 정보

​		`productStatus`: 채팅방 상태
0: 판매자가 구매완료 누르지 않은 상태에서 **구매자(구매자란 표현X, 정확히는 판매자를 제외한 유저)**가 채팅방에 들어갈 경우
1: 판매자가 구매완료 눌렀을 상태에서 **구매자**가 채팅방에 들어갈 경우
2: **판매자**가 채팅방에 들어갈 경우
3: 아예 채팅방의 물건자체가 삭제된 경우

​		`transactionStatus`(optional) : 해당 물건에 대해서 거래완료 를 했는지에 대한 유무( 1: 거래완료 됨, 2: [판매자입장]이미 다른 곳에서 거래가 완료됨)

​		`isReviewUpload`(optional) : 실제 구매자가 리뷰를 올렸는 지에 대한 유무 ( 1: 리뷰작성함 )

​		`reviewer_nickname`(optional) : [판매자에게만 보임]리뷰를 남긴 사람의 닉네임(리뷰어 리뷰를 남기지 않아도 누구와 거래했는 지에 대한 닉네임 정보는 알 수 있음)

`warn`(boolean) : 상대방이 경고 받고 있는 지 유무(defalut = false)

`block_status` : 차단 상태( 1:내가상대방차단(상대방도 나를 차단했을 경우도 이 경우에 포함됨), 2: 내가 상대방을 차단하지 않았지만 상대방이 나를 차단한 경우, 3: 서로 아무도 차단하지 않은 상태)
=> 이 부분은 기존의 차단조회 API 와 똑같다



** 만약 `<span style="color:red">*`warn*</span> `: true, `block_status` : 1
일 경우라면 어떻게 UI를 표현해야 할까
`warn` 에 따른 경고표시는 별개로 나두고 `block_status` 에 따른 차단관련UI는 역시 따로 둔다.
이렇게 하는 이유는 차단하기를 해제했을 경우, 경고유무 표시가 전혀 보여지지 않게 된다.
즉, 나는 차단을 했지만 사실상 상대방은 경고를 당하고 있었는 데 그걸 전혀 모르기 때문이다.
따라서 경고는 경고대로 따로 UI가 있고 차단은 차단과 관련된 UI 형태를 만들면 될 듯함



1.
**example**

채팅방에 판매자본인이 들어갔을 경우 + 아직 거래완료 누르지 않은 상태
클라이언트는 거래완료 버튼을 활성화 하도록 한다.

```json

{
    "productStatus": 2,
    "warn": true,
    "block_status": 1
}

```


2.
**example**

(판매자가 구매완료 버튼 누른)판매자본인이 들어갔을 경우 그런데 아직 구매자가 사용후기를 남기지 않았을 경우

클라이언트는 거래완료 버튼을 비활성화 상태로 만들 되, 아직 구매자가 사용후기를 남기지 않았기 때문에
"아직 구매자가 사용후기를 작성하지 않았습니다" 등의 문구정도는 채팅방 상단 섹션에 띄어준다.

 ```json
{
    "productStatus": 2,
    "transactionStatus": 1, 
    "reviewer_nickname": "fgh0296",
    "warn": true,
    "block_status": 1
}

```
3.

(판매자가 구매완료 버튼 누른)채팅방에 판매자본인이 들어갔는데, 구매자가 후기를 남겨준 경우
클라이언트는 이 경우, 거래완료도 했고, 구매자가 거래후기를 남겼기 떄문에
" 구매자가 거래후기를 남겼습니다 :) 거래후기 보기 " 등과 같은 버튼이나 문구를 채팅방 상단 섹션 DOM
에 그려준다.
그리고 거래완료 버튼은 비활성화 또는 거래하기 버튼 모양이 거래완료라는 것을 뜻하는 버튼모양으로 바뀐다.

**example**
```json

{
    "productStatus": 2,
    "transactionStatus": 1,
    "isReviewUpload": 1,
    "reviewer_nickname": "fgh0296",
    "warn": true,
    "block_status": 1
}


```


4.

(판매자가 거래완료 버튼 누른) 채팅방에 `구매자`가 들어가는 경우 + 구매자가 리뷰를 남기지 않은 경우
클라이언트는 이 경우 [후기 남기기] 라는 버튼을 생성하여 후기를 남길 수 있도록 한다.

**example**


```json

{
    "productStatus": 1,
    "transactionStatus": 1,
    "warn": true,
    "block_status": 1
}

```

5.

(판매자가 거래완료 버튼 누른) 채팅방에 `구매자` 가 들어가는 경우 + 구매자가 리뷰를 남긴 경우
클라이언트는 [후기 남기기] 버튼이 아닌 이미 내용을 입력한 상태이기 떄문에, [내가 남긴 후기 보기] 등으로
문구를 바꾸면 될 것이다.

**example**
```json

{
    "productStatus": 1,
    "transactionStatus": 1,
    "isReviewUpload": 1,
    "warn": true
}

```


6.

구매자가 아직 거래완료 되지 않은 채팅방에 들어가는 경우  
만약 이 경우 클라이언트는 아무런 조치를 하지 않아도 된다.

```json

{
    "productStatus": 0,
    "warn": true,
    "block_status": 1
}

```

7.
**example**

<span style="color: red;">채팅방의 물건이 삭제된 경우</span>.

```json

{
    "productStatus": 3,
    "warn": true,
    "block_status": 1
}

```




8.[판매자]이미 거래완료를 한 물건에 대해서, 해당 이미 판 물건의 다른 채팅방(거래완료 버튼을 누르지 않은)에 들어갔을 경우
**example**

```json

{
    "productStatus": 2,
    "transactionStatus": 2,
    "warn": true,
    "block_status": 1
}

```
---



## 예외 응답 response


### 1. 상대방이 탈퇴했을 경우

```json

{
    "statusCode": 404,
    "timestamp": "2021-03-26T01:33:39.510+00:00",
    "message": "탈퇴한 유저와 채팅거래를 할 수 없습니다.",
    "requestPath": "uri=/api/chatroom/444/status",
    "pathToMove": null
}

```


### 2. 상대방이 관리자로 부터 유저제재 당했을 경우

```json

{
    "statusCode": 404,
    "timestamp": "2021-03-26T01:34:49.390+00:00",
    "message": "관리자로부터 이용제재를 받고 있는 유저와 채팅거래를 할 수 없습니다.",
    "requestPath": "uri=/api/chatroom/444/status",
    "pathToMove": null
}

```







