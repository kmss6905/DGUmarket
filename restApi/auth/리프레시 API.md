### 리프레시 API



리프레시 API를 요청하는 경우는 다음과 같습니다.

- **페이지 반환 과정**에서 리프레시 API 요청
- **주기적**으로 리프레시 API 요청

리프레시 API를 통해서 클라이언트 측에서 A토큰을 반환 받고, 서비스 이용 기간 내에서 계속적으로 로그인 상태를 유지시키는 역할을 합니다.

리프레시 API 로직 설명하고, 각각의 경우의 응답 예시를 설명하겠습니다.

**로직**

리프레시 API는 R 토큰을 통해서 클라이언트(유저)가 갖고 있는 A 토큰을 갱신 또는 A 토큰을 생성해서 반환합니다.

1. 최초 로그인 시점 이후 유효한 R 토큰만 갖고 있는 클라이언트가 리프레시 API를 요청하는 경우 :

   로그인 이후, 브라우저를 끄고 다시 우리 도메인에 접속하는 경우 : (A 토큰 없이 R 토큰(유효)만 있는 경우)

   **또는**

   클라이언트 측에서 유효한 R 토큰과 A 토큰을 가지고 있는 경우에 리프레시 API를 요청하는 경우 :

   **<응답 예시>**

```json
// R 토큰이 유효한 경우 아래와 같이 토큰 갱신이 성공합니다.
// 이 때, R 토큰도 같이 갱신됩니다. (쿠키)
{
    "message": "JWT 토큰 갱신 성공",
    "status": 200,
    "data": {
        "tokenType": "Bearer",
        "accessToken":  "A 토큰 값", 
        "userId": 0, // 유저 고유 아이디
        "userNickName": "유저 닉네임", 
        "userProfileImgDir": "/imgs/slideshow_sample.jpg" // 유저 프로필 사진 저장 경로 
    }
}
```



2. *유저가 임의로 R 토큰을 삭제하고, A 토큰을 가지고 있는 상태에서 리프레시 API를 요청하는 경우*

   ****

   **R 토큰이 없고 (삭제했으므로) A 토큰만 가지고 있는 상태**는 두 가지 상황으로 나뉩니다.

   A 토큰이 유효한 경우 / 유효하지 않은 경우

   먼저, **A 토큰이 유효한 경우**는 해당 A 토큰을 그대로 반환합니다. 리프레시 API 결과 토큰 갱신에 실패합니다. 클라이언트는 해당 A 토큰이 만료되기 전까지는 인증된 상태로 서비스 이용이 가능합니다.

   **<응답 예시>**

   ```json
   // A 토큰이 만료 전 까지 유저는 인증 상태로 서비스 이용이 가능하다. 
   {
       "message": "R 토큰이 없고, A 토큰이 유효한 경우 -> 리프레시 API 요청한 페이지에 머무를 수 있다 (로그인 상태)",
       "status": 200,
       "data": "A 토큰 값"
   }
   ```

   이후 **A 토큰이 만료된 상태**에서 리프레시 API 요청을 하는 경우에는 리프레시 API를 요청하는 페이지가 인증을 요구하는 지 여부에 따라서 나뉘게 됩니다. 먼저 **인증을 요구하지 않는 페이지**에서 요청한 경우는 아래와 같은 응답을 하고 유저는 해당 페이지에 비로그인 상태로 남아 있게 됩니다.

   **<응답 예시>**

   ```json
   {
       "message": "Refresh 토큰이 없고 A 토큰 유효하지 않은 경우 -> 리프레시 API 요청한 페이지(인증 요구되지 않은 페이지)에 머무를 수 있다 (비로그인 상태)",
       "status": 200,
       "data": null
   }
   ```

   반대로, **인증을 요구하는 페이지**에서 리프레시 API를 요청하는 경우는 아래와 같이 응답을 하고, 로그인 페이지로 리다이렉트 처리됩니다. 이 때 로그인을 다시 하면 마지막으로 머물렀던 페이지로 이동하게 됩니다. 이는 비로그인 상태에서 중고물품 업로드 페이지 이동 시 로그인 페이지로 리다이렉트 처리되고 다시 로그인 이후 중고물품 업로드 페이지로 이동하는 것과 동일한 로직입니다.

   **<응답 예시>**

   ```json
   // 인증이 요구되는 '중고물품 업로드 페이지 요청 상황' (R 토큰 없고, A 토큰이 유효하지 않은 경우)
   
   (클라이언트) A, R 토큰 없는 상태에서 중고물품 업로드 페이지 요청  
   
   (서버) 로그인 페이지로 리다이렉트 (리프레시 API 결과)
   
   (클라이언트) 로그인 페이지로 요청하기 전, 로컬 스토리지에 기존 요청 URL 값을 저장 후 로그인 페이지 요청
   
   (서버) 로그인 페이지 반환 
   
   -------------------------------------------------------------------------------------------------------
   
   (클라이언트) 로그인 성공 시, 로컬 스토리지에 저장했던 기존 요청 URl 값 활용해서 페이지 이동 
   
   
   ```



3. *R 토큰이 유효하지 않은 경우*



우선 사용자가 서비스를 연속적으로 이용하는 상황 (리프레시 API가 계속적으로 호출되면서)에서는 R 토큰은 만료되지 않습니다. 임의로 R 토큰을 삭제하는 경우는 있을 수 있지만, R 토큰이 만료된 상황에서 A 토큰이 있는 경우는 있을 수 없습니다. 브라우저를 끄고 난 뒤 R 토큰이 만료된 이후에 다시 우리 서비스를 이용하는 경우가 3번의 상황이라고 이해하시면 됩니다. 브라우저를 끄는 이벤트로 A 토큰이 소멸된 상태입니다.

"HTTP 요청을 수신할 때, 서버는 응답과 함께 [`Set-Cookie`](https://developer.mozilla.org/ko/docs/Web/HTTP/Headers/Set-Cookie) 헤더를 전송할 수 있습니다. 쿠키는 보통 브라우저에 의해 저장되며, 그 후 쿠키는 같은 서버에 의해 만들어진 요청(Request)들의 [`Cookie`](https://developer.mozilla.org/ko/docs/Web/HTTP/Headers/Cookie) HTTP 헤더안에 포함되어 전송됩니다. 만료일 혹은 지속시간(duration)도 명시될 수 있고, **<u>만료된 쿠키는 더이상 보내지지 않습니다</u>**. 추가적으로, 특정 도메인 혹은 경로 제한을 설정할 수 있으며 이는 쿠키가 보내지는 것을 제한할 수 있습니다."

출처 : https://developer.mozilla.org/ko/docs/Web/HTTP/Cookies



**결국 위 상황에서는 A, R 토큰 없이 페이지를 요청하는 상황으로 이해하시면 됩니다.** 인증을 요구하지 않는 페이지의 경우에는 해당 페이지를 반환하게 되고 (비로그인 상태), **인증을 요구하는 페이지를 요청**하는 경우에는 아래와 같이 동작합니다.



**<응답 예시>**

   ```json
   // 인증이 요구되는 '중고물품 업로드 페이지 요청 상황' (R 토큰 없고, A 토큰도 없는 경우)
   
   (클라이언트) A, R 토큰 없는 상태에서 중고물품 업로드 페이지 요청  
   
   (서버) 로그인 페이지로 리다이렉트 (리프레시 API 결과)
   
   (클라이언트) 로그인 페이지로 요청하기 전, 로컬 스토리지에 기존 요청 URL 값을 저장 후 로그인 페이지 요청
   
   (서버) 로그인 페이지 반환 
   
   -------------------------------------------------------------------------------------------------------
   
   (클라이언트) 로그인 성공 시, 로컬 스토리지에 저장했던 기존 요청 URl 값 활용해서 페이지 이동 
   
   
   ```



4. 회원 탈퇴한 유저, 관리자로부터 이용 제재를 받은 유저가 리프레시 API 요청을 한 경우

   먼저, 회원탈퇴한 유저가 리프레시 API를 요청하는 경우는 다음과 같습니다. 여러 브라우저를 통해 우리 서비스를 이용하는 경우 A 브라우저에서 탈퇴 시점 이후에 B 브라우저에서는 페이지 이동을 하지 않거나, 주기적으로 호출되는 리프레시 API 이전 상태 그리고 '채팅으로 거래하기' 등과 같은 이미 머무르고 있는 페이지에서 요청할 수 있는 API를 요청하기 전까지는 해당 페이지에 머무르는 상태가 됩니다.

   또한 이용 제재를 받은 시점 이후에 이용 제재를 받은 유저가 위와 같이 로그인 상태로 -- 페이지에 머무르고 있을 수 있습니다.

   위 경우 중, **리프레시 API를 요청하는 경우**는 아래와 같이 응답을 받게 됩니다.

   **<응답 예시>**

- 회원 탈퇴한 유저가 리프레시 API 요청을 하는 경우

```json
{
    "statusCode": 401,
    "timestamp": "2021-03-09 11:51:24",
    "message": "가입하지 않은 아이디이거나, 잘못된 비밀번호입니다." 
}
```

- 서비스 이용 제재를 받은 유저가 리프레시 API 요청을 하는 경우

```json
{
    "statusCode": 401,
    "timestamp": "2021-03-09 06:50:36",
    "message": "관리자에 의해서 서비스 이용이 제재된 웹메일 계정입니다. 로그인 문의는 관리자 메일을 통해 연락해주세요."
}
```

**결론**으로,

리프레시 API 응답으로 **401**을 받은 경우에는 로그인 페이지로 이동시키시면 됩니다.

이 때는 서버로부터 **리다이렉트로 인해서 로그인 페이지**로 이동하는 것이 아니라, 클라이언트 측에서 해당 상황에서 로그인 페이지로 이동시키는 상황입니다.



5. (마지막) Redis 블랙리스트에 포함된 R 토큰으로 리프레시 API 요청한 경우

   Redis 블랙리스트는 유효한 R 토큰이지만 이미 로그아웃 또는 탈퇴로 인해 발급했던 토큰을 더 이상 사용되지 않는 조건이 확인된 이후 재사용을 방지하기 위해 도입된 리스트입니다. R 토큰이 유효하지만, 위에서 설명한 블랙리스트에 포함된 R 토큰으로 리프레시 API를 요청하는 경우는 아래와 같이 인증 요구 여부에 따라 다르게 응답합니다.



**<응답 예시>**

   ```json
   // 인증이 요구되지 않는 페이지에서 리프레시 API 요청하는 경우
   {
       "message": "Refresh 토큰 갱신 실패(Redis 블랙리스트우에 포함된 R 토큰) + 인증이 요구되지 않은 페이지에서 요청 -> 해당 페이지 유지 (비로그인상태)",
       "status": 200,
       "data": null
   }
   ```

반대로, **인증을 요구하는 페이지**에서 리프레시 API를 요청하는 경우는 아래와 같이 응답을 하고, 로그인 페이지로 리다이렉트 처리됩니다. 이 때 로그인을 다시 하면 마지막으로 머물렀던 페이지로 이동하게 됩니다. 이는 비로그인 상태에서 중고물품 업로드 페이지 이동 시 로그인 페이지로 리다이렉트 처리되고 다시 로그인 이후 중고물품 업로드 페이지로 이동하는 것과 동일한 로직입니다.

**<응답 예시>**

   ```json
   // 인증이 요구되는 '중고물품 업로드 페이지 요청 상황' (R 토큰 없고, A 토큰이 유효하지 않은 경우)
   
   (클라이언트) A, R 토큰 없는 상태에서 중고물품 업로드 페이지 요청  
   
   (서버) 로그인 페이지로 리다이렉트 (리프레시 API 결과)
   
   (클라이언트) 로그인 페이지로 요청하기 전, 로컬 스토리지에 기존 요청 URL 값을 저장 후 로그인 페이지 요청
   
   (서버) 로그인 페이지 반환 
   
   -------------------------------------------------------------------------------------------------------
   
   (클라이언트) 로그인 성공 시, 로컬 스토리지에 저장했던 기존 요청 URl 값 활용해서 페이지 이동 
   
   
   ```

   